generator client {
  provider = "prisma-client-py"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//
// ─── ENUMS ─────────────────────────────────────────────
//
enum GroupRole {
  ADMIN
  MEMBER
}

//
// ─── USERS ─────────────────────────────────────────────
//
model User {
  id          String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String
  email       String       @unique
  password    String
  created_by  String?      @db.Uuid
  updated_by  String?      @db.Uuid
  deleted_by  String?      @db.Uuid
  created_at  DateTime     @default(now()) @db.Timestamptz(6)
  updated_at  DateTime?    @db.Timestamptz(6)
  deleted_at  DateTime?    @db.Timestamptz(6)

  // Relations for audit fields on User
  creator     User?        @relation("UserCreator", fields: [created_by], references: [id], onDelete: SetNull)
  updater     User?        @relation("UserUpdater", fields: [updated_by], references: [id], onDelete: SetNull)
  deleter     User?        @relation("UserDeleter", fields: [deleted_by], references: [id], onDelete: SetNull)

  // Reverse relations for User audit trails
  usersCreated User[]      @relation("UserCreator")
  usersUpdated User[]      @relation("UserUpdater")
  usersDeleted User[]      @relation("UserDeleter")

  // Relations to other models
  groupMemberships     GroupMember[] @relation("UserGroupMemberships")
  groupMembersCreated  GroupMember[] @relation("GroupMemberCreator")
  groupMembersUpdated  GroupMember[] @relation("GroupMemberUpdater")
  groupMembersDeleted  GroupMember[] @relation("GroupMemberDeleter")

  groupsCreated        Group[]       @relation("GroupCreator")
  groupsUpdated        Group[]       @relation("GroupUpdater")
  groupsDeleted        Group[]       @relation("GroupDeleter")

  billsCreated         Bill[]        @relation("BillCreator")
  billsUpdated         Bill[]        @relation("BillUpdater")
  billsDeleted         Bill[]        @relation("BillDeleter")

  billShares           BillShare[]   @relation("UserBillShares")
  billSharesCreated    BillShare[]   @relation("BillShareCreator")
  billSharesUpdated    BillShare[]   @relation("BillShareUpdater")
  billSharesDeleted    BillShare[]   @relation("BillShareDeleter")

  @@index([email])
  @@index([created_by])
  @@index([updated_by])
  @@index([deleted_by])
}

//
// ─── GROUPS ────────────────────────────────────────────
//
model Group {
  id          String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String
  description String?
  created_by  String?    @db.Uuid
  updated_by  String?    @db.Uuid
  deleted_by  String?    @db.Uuid
  created_at  DateTime   @default(now()) @db.Timestamptz(6)
  updated_at  DateTime?  @db.Timestamptz(6)
  deleted_at  DateTime?  @db.Timestamptz(6)

  // Relations
  creator     User?          @relation("GroupCreator", fields: [created_by], references: [id], onDelete: SetNull)
  updater     User?          @relation("GroupUpdater", fields: [updated_by], references: [id], onDelete: SetNull)
  deleter     User?          @relation("GroupDeleter", fields: [deleted_by], references: [id], onDelete: SetNull)

  members     GroupMember[]
  bills       Bill[]

  @@index([name])
  @@index([created_by])
  @@index([updated_by])
  @@index([deleted_by])
}

//
// ─── GROUP MEMBERS ─────────────────────────────────────
//
model GroupMember {
  id          String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id     String      @db.Uuid
  group_id    String      @db.Uuid
  created_by  String      @db.Uuid          // who added the member
  updated_by  String?     @db.Uuid
  deleted_by  String?     @db.Uuid
  role        GroupRole   @default(MEMBER)
  created_at  DateTime    @default(now()) @db.Timestamptz(6)
  updated_at  DateTime?   @db.Timestamptz(6)
  deleted_at  DateTime?   @db.Timestamptz(6)

  // Relations
  user        User        @relation("UserGroupMemberships", fields: [user_id], references: [id], onDelete: Cascade)
  group       Group       @relation(fields: [group_id], references: [id], onDelete: Cascade)
  creator     User        @relation("GroupMemberCreator", fields: [created_by], references: [id], onDelete: Restrict)
  updater     User?       @relation("GroupMemberUpdater", fields: [updated_by], references: [id], onDelete: SetNull)
  deleter     User?       @relation("GroupMemberDeleter", fields: [deleted_by], references: [id], onDelete: SetNull)

  @@unique([user_id, group_id])
  @@index([group_id])
  @@index([user_id])
  @@index([created_by])
  @@index([updated_by])
  @@index([deleted_by])
}

//
// ─── BILLS ─────────────────────────────────────────────
//
model Bill {
  id           String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  group_id     String      @db.Uuid
  created_by   String      @db.Uuid
  updated_by   String?     @db.Uuid
  deleted_by   String?     @db.Uuid
  description  String
  total_amount Float
  created_at   DateTime    @default(now()) @db.Timestamptz(6)
  updated_at   DateTime?   @db.Timestamptz(6)
  deleted_at   DateTime?   @db.Timestamptz(6)

  // Relations
  group       Group        @relation(fields: [group_id], references: [id], onDelete: Cascade)
  creator     User         @relation("BillCreator", fields: [created_by], references: [id], onDelete: Restrict)
  updater     User?        @relation("BillUpdater", fields: [updated_by], references: [id], onDelete: SetNull)
  deleter     User?        @relation("BillDeleter", fields: [deleted_by], references: [id], onDelete: SetNull)

  shares      BillShare[]

  @@index([group_id])
  @@index([created_by])
  @@index([updated_by])
  @@index([deleted_by])
}

//
// ─── BILL SHARES ───────────────────────────────────────
//
model BillShare {
  id          String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  bill_id     String     @db.Uuid
  user_id     String     @db.Uuid
  created_by  String?    @db.Uuid
  updated_by  String?    @db.Uuid
  deleted_by  String?    @db.Uuid
  amount      Float
  paid        Boolean    @default(false)
  created_at  DateTime   @default(now()) @db.Timestamptz(6)
  updated_at  DateTime?  @db.Timestamptz(6)
  deleted_at  DateTime?  @db.Timestamptz(6)

  // Relations
  bill        Bill       @relation(fields: [bill_id], references: [id], onDelete: Cascade)
  user        User       @relation("UserBillShares", fields: [user_id], references: [id], onDelete: Cascade)
  creator     User?      @relation("BillShareCreator", fields: [created_by], references: [id], onDelete: SetNull)
  updater     User?      @relation("BillShareUpdater", fields: [updated_by], references: [id], onDelete: SetNull)
  deleter     User?      @relation("BillShareDeleter", fields: [deleted_by], references: [id], onDelete: SetNull)

  @@unique([bill_id, user_id])
  @@index([bill_id])
  @@index([user_id])
  @@index([created_by])
  @@index([updated_by])
  @@index([deleted_by])
}